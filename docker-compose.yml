version: "3.9"

services:
  vite-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: vite-dev
    environment:
      PORT: ${FRONTEND_PORT}
      VITE_BACKEND_URL: ${VITE_BACKEND_URL}
    env_file:
      - ./.env
    ports:
      - "${FRONTEND_PORT}:${FRONTEND_PORT}"
    volumes:
      - ./frontend:/frontend
    command: sh -c "yarn install && yarn dev --host 0.0.0.0"

  backend-dev:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: dev_backend
    env_file:
      - ./.env
    environment:
      PORT: $BACKEND_PORT
      MONGO_DB: ${MONGO_DB}
      MONGO_DB_USER: ${MONGO_DB_USER}
      MONGO_DB_PASSWORD: ${MONGO_DB_PASSWORD}
      MONGO_DB_URL: ${MONGO_DB_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      JAVA_OPTS: -Dspring.devtools.restart.enabled=true -Dspring.devtools.livereload.enabled=true
      SPRING_PROFILES_ACTIVE: dev
    ports:
      - "$BACKEND_PORT:$BACKEND_PORT"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - dev_network
    volumes:
      - ./backend/src:/backend/src
      - ./backend/.mvn/.m2:/root/.m2
    command: ./reload.sh

  mongodb:
    build:
      context: ./mongodb
      dockerfile: Dockerfile
    container_name: mongodb
    ports:
      - "${MONGO_DB_PORT}:${MONGO_DB_PORT}"
    environment:
      PORT: ${MONGO_DB_PORT}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_DB_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_DB_PASSWORD}
    networks:
      - dev_network
    healthcheck:
      test:
        [
          "CMD",
          "mongosh",
          "--host",
          "127.0.0.1",
          "--port",
          "${MONGO_DB_PORT}",
          "--eval",
          "db.adminCommand('ping')",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  dev_network:
    driver: bridge
